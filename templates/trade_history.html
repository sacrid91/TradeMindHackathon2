<!-- templates/trade_history.html -->
{% extends "base.html" %}

{% block title %}Trade History{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <h2 class="text-2xl font-bold mb-6">Trade History</h2>

  <!-- Balance Calculator -->
  <div class="card mb-6">
    <h3 class="font-bold mb-3">Account Balance Tracker</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block mb-1">Initial Account</label>
        <input type="number" id="initial-balance" step="0.01" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg" placeholder="e.g., 10000">
      </div>
      <div>
        <label class="block mb-1">Previous Balance</label>
        <input type="text" id="previous-balance" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" readonly>
      </div>
      <div>
        <label class="block mb-1">Current Balance</label>
        <input type="text" id="current-balance" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" readonly>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-6">
    <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div>
        <label>Pair</label>
        {{ filter_form.pair }}
      </div>
      <div>
        <label>Session</label>
        {{ filter_form.session }}
      </div>
      <div>
        <label>Profit</label>
        {{ filter_form.profit }}
      </div>
      <div>
        <label>Loss</label>
        {{ filter_form.loss }}
      </div>
      <div>
        <label>Date</label>
        {{ filter_form.date }}
      </div>
      <div class="md:col-span-5">
        <button type="submit" class="btn-primary">Filter</button>
        <a href="{% url 'trademind_app:trade_history' %}" class="ml-2 text-sm text-gray-400">Clear</a>
      </div>
    </form>
  </div>

  <!-- Trade Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-gray-800 border border-gray-700 rounded-lg">
      <thead>
        <tr class="bg-gray-900">
          <th class="px-4 py-2">Date</th>
          <th class="px-4 py-2">Pair</th>
          <th class="px-4 py-2">Entry</th>
          <th class="px-4 py-2">Session</th>
          <th class="px-4 py-2">Profit</th>
          <th class="px-4 py-2">Loss</th>
          <th class="px-4 py-2">Lot Size</th>
          <th class="px-4 py-2">Emotion (Pre)</th>
          <th class="px-4 py-2">Rules Followed</th>
          <th class="px-4 py-2">Screenshot</th>
          <th class="px-4 py-2">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for trade in page_obj %}
        <tr class="border-b border-gray-700 hover:bg-gray-700">
          <td class="px-4 py-2">{{ trade.date }}</td>
          <td class="px-4 py-2">{{ trade.pair }}</td>
          <td class="px-4 py-2">{{ trade.entry }}</td>
          <td class="px-4 py-2">{{ trade.get_session_display }}</td>
          <td class="px-4 py-2 text-green-400">{{ trade.profit }}</td>
          <td class="px-4 py-2 text-red-400">{{ trade.loss }}</td>
          <td class="px-4 py-2">{{ trade.lot_size }}</td>
          <td class="px-4 py-2">{{ trade.get_pre_trade_emotion_display }}</td>
          <td class="px-4 py-2">{{ trade.rules_followed.count }}/{{ user.rules.count }}</td>
          <td class="px-4 py-2">
            {% if trade.screenshot %}
              <a href="{{ trade.screenshot.url }}" target="_blank" class="text-emerald-400">View</a>
            {% endif %}
          </td>
          <td class="px-4 py-2">
            <a href="{% url 'trademind_app:ai_insight' trade.id %}" class="text-blue-400 text-sm">Insight</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="11" class="px-4 py-6 text-center text-gray-400">No trades found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="flex justify-center mt-6">
    {% if page_obj.has_previous %}
      <a href="?page=1" class="px-3 py-1 bg-gray-700 rounded-l-lg">First</a>
      <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 bg-gray-700">Previous</a>
    {% endif %}

    <span class="px-3 py-1 bg-emerald-500">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 bg-gray-700">Next</a>
      <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-1 bg-gray-700 rounded-r-lg">Last</a>
    {% endif %}
  </div>
</div>

<!-- Balance Calculator Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const initialInput = document.getElementById("initial-balance");
    const prevOutput = document.getElementById("previous-balance");
    const currentOutput = document.getElementById("current-balance");

    // Get all profit/loss values from the table (hidden or visible)
    const profits = [{% for trade in trades %}{% if trade.profit %}{{ trade.profit }},{% endif %}{% endfor %}].filter(Boolean).map(Number);
    const losses = [{% for trade in trades %}{% if trade.loss %}-{{ trade.loss }},{% endif %}{% endfor %}].filter(Boolean).map(Number);

    const totalPnL = [...profits, ...losses].reduce((a, b) => a + b, 0);
    const lastPnL = losses.length > 0 ? losses[losses.length - 1] : profits[profits.length - 1] || 0;

    initialInput.addEventListener("input", function () {
      const initial = parseFloat(initialInput.value) || 0;
      prevOutput.value = (initial + totalPnL - lastPnL).toFixed(2);
      currentOutput.value = (initial + totalPnL).toFixed(2);
    });
  });
</script>
{% endblock %}